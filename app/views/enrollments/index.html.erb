
<% unless @enrollments.first.nil? %>

    <table class="enrollmenttable" style="width:100%;">
      <thead>
      <th>
        Opiskelija
      </th>
      <% @projects.each do |project| %>
          <th>
            <%= project.name %>
          </th>
      <% end %>
      <th>
        Hyväksyttyjen lukumäärä
      </th>
      <th>
        Magic number
      </th>
      </thead>

      <tbody>
      <% @enrollments.each do |enrollment| %>

          <tr>
            <td>
              <%= enrollment.name %>
            </td>
            <% @projects.each do |project| %>
                <% signup = enrollment.signups.find_by(project_id:project.id) %>
                <% unless signup.nil? %>
                    <td id="<%= enrollment.id %>-<%= project.id %>" onclick="toggle(<%= enrollment.id %>, <%= project.id %>)" class="prioritycell<%= ' accepted' if signup.status %>"<%= 'class=accepted' if signup.status %>>
                      <%= signup.priority %>
                    </td>
                <% else %>
                    <td></td>
                <% end %>
            <% end %>
            <td id="<%= enrollment.id %>-etotal">
              <%= enrollment.accepted_amount %>
            </td>
            <td id="<%= enrollment.id %>-escore">
              <%= enrollment.compute_magic_number %>
            </td>
          </tr>
      <% end %>
      </tr>
      </tbody>

      <tfoot>
      <tr>
        <td>Opiskelijoita</td>
        <% @projects.each do |project| %>

            <td id="<%= project.id %>-ptotal">
              <%= project.amount_of_accepted_students %> / <%= project.maxstudents %>
            </td>
        <% end %>
      </tr>
      <tr>
        <td>Täyttöaste</td>
        <% @projects.each do |project| %>

            <td id="<%= project.id %>-pfill">
              <%= project.amount_of_accepted_students - project.maxstudents %>
            </td>
        <% end %>
      </tr>
      </tfoot>

    </table>

<% else %>
    <h2>Ei ilmoittautumisia.</h2>
<% end %>


<% content_for :header do %>
    Ilmoittautumisnäkymä
<% end %>

<script>
    function toggle(enrollment_id, project_id) {
        $.ajax({
            type: "POST",
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            url: "toggle",
            data: { enrollment_id: enrollment_id, project_id: project_id }
        })
                .done(function( msg ) {
                    document.getElementById(project_id+"-ptotal").innerHTML = msg.acceptedStudents + " / " +msg.maxStudents;
                    document.getElementById(enrollment_id+"-etotal").innerHTML = msg.acceptedProjects;
                    document.getElementById(enrollment_id+"-escore").innerHTML = msg.magicNumber;
                    document.getElementById(project_id+"-pfill").innerHTML = msg.acceptedStudents - msg.maxStudents;
                    $("#"+enrollment_id +"-"+project_id).toggleClass("accepted");
                });
    };



</script>
